# This file will be used to generate all of the schema-*.json files in a bundle
schema: draft-07
name: "azure-mysql-flexible-server"
description: "Azure Database for MySQL Flexible Server is a fully managed production-ready database service designed for more granular control and flexibility over database management functions and configuration settings."
ref: github.com/massdriver-cloud/azure-mysql-flexible-server
access: "private"
type: "bundle"

steps:
  - path: src
    provisioner: terraform

params:
  examples:
    - __name: Development
      sku_name: B_Standard_B1ms
      storage_gb: 32
      backup_retention_days: 1
      high_availability: false
    - __name: Production
      sku_name: GP_Standard_D2ds_v4
      storage_gb: 256
      backup_retention_days: 30
      high_availability: true
  required:
    - mysql_version
    - username
    - sku_name
    - storage_gb
    - cidr
  properties:
    mysql_version:
      title: Version
      description: The version of MySQL to use. The version can be upgraded, but not downgraded.
      type: string
      default: "5.7"
      enum:
        - "8.0.21"
        - "5.7"
    username:
      title: Username
      description: The administrator login for the MySQL Flexible Server. (Cannot be 'admin', 'root', 'administrator', 'username', 'azure_superuser', 'azure_pg_admin', 'guest', or 'public'.)
      type: string
      not:
        enum:
          - admin
          - root
          - administrator
          - username
          - azure_superuser
          - azure_pg_admin
          - guest
          - public
    sku_name:
      title: Compute size
      description: Select the amount of cores, memory, and max iops you need for your workload (B = Burstable, D = General Purpose, E = Memory Optimized).
      type: string
      oneOf:
        - title: B1ms (1 vCore, 2 GiB memory, 640 max iops)
          const: B_Standard_B1ms
        - title: B2s (2 vCores, 4 GiB memory, 1280 max iops)
          const: B_Standard_B2s
        - title: B2ms (2 vCores, 8 GiB memory, 1780 max iops)
          const: B_Standard_B2ms
        - title: B4ms (4 vCores, 16 GiB memory, 2400 max iops)
          const: B_Standard_B4ms
        - title: B8ms (8 vCores, 32 GiB memory, 3100 max iops)
          const: B_Standard_B8ms
        - title: B16ms (16 vCores, 64 GiB memory, 4300 max iops)
          const: B_Standard_B16ms
        - title: D2ds (2 vCores, 8 GiB memory, 3200 max iops)
          const: GP_Standard_D2ds_v4
        - title: D4ds (4 vCores, 16 GiB memory, 6400 max iops)
          const: GP_Standard_D4ds_v4
        - title: D8ds (8 vCores, 32 GiB memory, 12800 max iops)
          const: GP_Standard_D8ds_v4
        - title: D16ds (16 vCores, 64 GiB memory, 18000 max iops)
          const: GP_Standard_D16ds_v4
        - title: D32ds (32 vCores, 128 GiB memory, 18000 max iops)
          const: GP_Standard_D32ds_v4
        - title: D48ds (48 vCores, 192 GiB memory, 18000 max iops)
          const: GP_Standard_D48ds_v4
        - title: D64ds (64 vCores, 256 GiB memory, 18000 max iops)
          const: GP_Standard_D64ds_v4
        - title: E2ds (2 vCores, 16 GiB memory, 3200 max iops)
          const: MO_Standard_E2ds_v4
        - title: E4ds (4 vCores, 32 GiB memory, 6400 max iops)
          const: MO_Standard_E4ds_v4
        - title: E8ds (8 vCores, 64 GiB memory, 12800 max iops)
          const: MO_Standard_E8ds_v4
        - title: E16ds (16 vCores, 128 GiB memory, 18000 max iops)
          const: MO_Standard_E16ds_v4
        - title: E32ds (32 vCores, 256 GiB memory, 18000 max iops)
          const: MO_Standard_E32ds_v4
        - title: E48ds (48 vCores, 384 GiB memory, 18000 max iops)
          const: MO_Standard_E48ds_v4
        - title: E64ds (64 vCores, 432 GiB memory, 18000 max iops)
          const: MO_Standard_E64ds_v4
    storage_gb:
      title: Storage
      description: The storage you provision is the amount of storage capacity available to your Azure Database for MySQL server.
      type: integer
      oneOf:
        - title: 20GB
          const: 20
        - title: 32GB
          const: 32
        - title: 64GB
          const: 64
        - title: 128GB
          const: 128
        - title: 256GB
          const: 256
        - title: 512GB
          const: 512
        - title: 1TB
          const: 1024
        - title: 2TB
          const: 2048
        - title: 4TB
          const: 4096
        - title: 8TB
          const: 8192
        - title: 16TB
          const: 16384
    cidr:
      title: Subnet CIDR
      type: string
      description: Specify a /28 CIDR range within your vnet to create subnet for the database
      $md.immutable: true
      pattern: ^(?:10\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])|172\.(?:1[6-9]|2[0-9]|3[0-1])|192\.168)(?:\.(?:[0-9]|[0-9]{2}|1[0-9][0-9]|2[0-4][0-9]|25[0-5])){2}\/28$
      message:
        pattern: "Must be a /28 range from within the VNet CIDR"
    backup_retention_days:
      title: Backup Retention
      description: How many days to retain MySQL database backups (minimum of 1, maximum of 35).
      type: integer
      default: 7
      minimum: 1
      maximum: 35
    high_availability:
      title: Enable High Availability
      description: Zone redundant high availability deploys a standby replica within the same zone for automatic failover in the event of an outage.
      type: boolean
      default: false

connections:
  required:
    - azure_service_principal
    - vnet
  properties:
    azure_service_principal:
      $ref: massdriver/azure-service-principal
    vnet:
      $ref: massdriver/azure-virtual-network

artifacts:
  required:
    - authentication
  properties:
    authentication:
      $ref: massdriver/mysql-authentication

ui:
  ui:order:
    - mysql_version
    - sku_name
    - storage_gb
    - username
    - cidr
    - backup_retention_days
    - high_availability